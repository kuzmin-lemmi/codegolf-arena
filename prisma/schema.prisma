// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Пользователь
model User {
  id                String    @id @default(uuid())
  // Stepik OAuth (опционально)
  stepikUserId      Int?      @unique @map("stepik_user_id")
  // Email авторизация (опционально)
  email             String?   @unique
  passwordHash      String?   @map("password_hash")
  emailVerified     Boolean   @default(false) @map("email_verified")
  // Общие поля
  displayName       String    @map("display_name")
  nickname          String?
  nicknameKey       String?   @unique @map("nickname_key")
  nicknameChangedAt DateTime? @map("nickname_changed_at")
  avatarUrl         String?   @map("avatar_url")
  totalPoints       Int       @default(0) @map("total_points")
  isAdmin           Boolean   @default(false) @map("is_admin")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  submissions     Submission[]
  bestSubmissions BestSubmission[]
  sessions        Session[]
  competitionEntries CompetitionEntry[]

  @@map("users")
}

// Сессия
model Session {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// Задача
model Task {
  id                String   @id @default(uuid())
  slug              String   @unique
  title             String
  tier              String   @default("bronze") // bronze, silver, gold
  mode              String   @default("practice") // practice, tournament
  statementMd       String   @map("statement_md")
  functionSignature String   @map("function_signature")
  functionArgs      String   @map("function_args") // JSON array
  exampleInput      String   @map("example_input")
  exampleOutput     String   @map("example_output")
  constraintsJson   String   @map("constraints_json") // JSON
  status            String   @default("draft") // draft, published, archived
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  testcases         Testcase[]
  submissions       Submission[]
  bestSubmissions   BestSubmission[]
  weeklyChallenges  WeeklyChallenge[]
  competitionTasks  CompetitionTask[]

  @@map("tasks")
}

// Тесткейс
model Testcase {
  id             String  @id @default(uuid())
  taskId         String  @map("task_id")
  inputData      String  @map("input_data") // JSON
  expectedOutput String  @map("expected_output")
  isHidden       Boolean @default(false) @map("is_hidden")
  orderIndex     Int     @default(0) @map("order_index")

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("testcases")
}

// Попытка решения
model Submission {
  id          String   @id @default(uuid())
  taskId      String   @map("task_id")
  userId      String   @map("user_id")
  code        String
  codeLength  Int      @map("code_length")
  status      String   @default("pending") // pending, pass, fail, error
  testsPassed Int      @default(0) @map("tests_passed")
  testsTotal  Int      @default(0) @map("tests_total")
  runtimeMs   Int?     @map("runtime_ms")
  errorMsg    String?  @map("error_msg")
  createdAt   DateTime @default(now()) @map("created_at")

  task           Task             @relation(fields: [taskId], references: [id])
  user           User             @relation(fields: [userId], references: [id])
  bestSubmission BestSubmission?

  @@map("submissions")
}

// Лучший результат пользователя по задаче
model BestSubmission {
  id           String   @id @default(uuid())
  taskId       String   @map("task_id")
  userId       String   @map("user_id")
  submissionId String   @unique @map("submission_id")
  codeLength   Int      @map("code_length")
  achievedAt   DateTime @default(now()) @map("achieved_at")

  task       Task       @relation(fields: [taskId], references: [id])
  user       User       @relation(fields: [userId], references: [id])
  submission Submission @relation(fields: [submissionId], references: [id])

  @@unique([taskId, userId])
  @@map("best_submissions")
}

// Задача недели
model WeeklyChallenge {
  id        String   @id @default(uuid())
  taskId    String   @map("task_id")
  startsAt  DateTime @map("starts_at")
  endsAt    DateTime @map("ends_at")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  task Task @relation(fields: [taskId], references: [id])

  @@map("weekly_challenges")
}

// Соревнование (новое!)
model Competition {
  id          String   @id @default(uuid())
  title       String
  description String?
  startsAt    DateTime @map("starts_at")
  endsAt      DateTime @map("ends_at")
  isActive    Boolean  @default(true) @map("is_active")
  resultsUrl  String?  @map("results_url") // Ссылка на результаты (Telegram/Stepik)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tasks   CompetitionTask[]
  entries CompetitionEntry[]

  @@map("competitions")
}

// Задачи в соревновании
model CompetitionTask {
  id            String @id @default(uuid())
  competitionId String @map("competition_id")
  taskId        String @map("task_id")
  orderIndex    Int    @default(0) @map("order_index")

  competition Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  task        Task        @relation(fields: [taskId], references: [id])

  @@unique([competitionId, taskId])
  @@map("competition_tasks")
}

// Участие в соревновании
model CompetitionEntry {
  id            String   @id @default(uuid())
  competitionId String   @map("competition_id")
  userId        String   @map("user_id")
  totalLength   Int      @default(0) @map("total_length") // Сумма длин решений
  tasksSolved   Int      @default(0) @map("tasks_solved")
  lastSubmitAt  DateTime? @map("last_submit_at")
  createdAt     DateTime @default(now()) @map("created_at")

  competition Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id])

  @@unique([competitionId, userId])
  @@map("competition_entries")
}
